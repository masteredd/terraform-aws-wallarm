# AWS VPCトラフィックミラーリングのための例示的なWallarmソリューションのサブモジュール

**INFO** これはTerraformモジュールまたはモジュールの例設定ではありません。この文書では、AWS VPCによってミラーリングされたトラフィック用の`terraform-aws-wallarm`モジュールを実行するために必要なサブモジュールの詳細を提供します。

`vpc-mirror-rebuild`サブモジュールは、VXLANパケットストリームからHTTPリクエストを再構築し、それらのリクエストをミラーリングされたトラフィックの分析を設定したWallarmノードに渡すことができるノードを実行します。

## 説明

モジュールには、Debian 10 AMIに基づくAutoscaling Groupと、`goreplay`を自動的にインストールするcloud-initスクリプトが含まれています。

`cloud-init.tftpl`には、cloud-initスクリプトの基本的なテンプレートが含まれており、以下の操作を行います:

* 必要なパッケージのセットをインストールします。
* `goreplay`をインストールします（この例をリリースする時点では、`vxlan`機能はマスターブランチでのみアクセス可能なため、ソースからビルドします）。
* インスタンスの再起動直後に`goreplay`を実行するように設定します。
* ロードバランサーのヘルスチェックを設定します。

## 使用詳細

このモジュールはいくつかのカスタマイズオプションをサポートしています。以下を設定することができます:

* 垂直スケーリングのための`instance_type`と、EC2インスタンスを配置する場所を定義するための`subnet_ids`。これらのインスタンスをプライベートサブネットに配置することを推奨します。
* `mirror_endpoint`変数。これは、抽出されたHTTPリクエストをWallarmノードに渡すためのエンドポイントです。

このアプリケーションを適切に設定するために、`vxlan_id`、`buffer_packet_expire`、および`buffer_size`を定義することができます:

* `vxlan_id`は、VXLAN VNIを定義することができます。複数のVXLANストリームが単一のロードバランサーやインスタンスに存在する場合に便利です。
* `buffer_packet_expire`と`buffer_size`はバッファーのリミットを設定します。

また、`debug`オプションを設定することもできます。これにより、systemdデーモンの`goreplay`アプリケーションのログの詳細度が有効になります（インスタンス上で`journalctl -xefu goreplay.service`を使用します）。